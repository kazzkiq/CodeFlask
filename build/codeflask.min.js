!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).CodeFlask=t()}(this,(function(){"use strict";const e="#fff";const t='"SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace';var n,s,o;const a=`\n  .codeflask {\n    position: absolute;\n    width: 100%;\n    height: 100%;\n    overflow: hidden;\n  }\n\n  .codeflask, .codeflask * {\n    box-sizing: border-box;\n  }\n\n  .codeflask__pre {\n    pointer-events: none;\n    z-index: 3;\n    overflow: hidden;\n  }\n\n  .codeflask__textarea {\n    background: none;\n    border: none;\n    color: ${n="caret-color",s="#000",("undefined"!=typeof CSS?CSS.supports(n,s):"undefined"!=typeof document&&(o=(o=n).split("-").filter((e=>!!e)).map((e=>e[0].toUpperCase()+e.substr(1))).join(""))[0].toLowerCase()+o.substr(1)in document.body.style)?e:"#ccc"};\n    z-index: 1;\n    resize: none;\n    font-family: ${t};\n    -webkit-appearance: pre;\n    caret-color: #111;\n    z-index: 2;\n    width: 100%;\n    height: 100%;\n  }\n\n  .codeflask--has-line-numbers .codeflask__textarea {\n    width: calc(100% - 40px);\n  }\n\n  .codeflask__code {\n    display: block;\n    font-family: ${t};\n    overflow: hidden;\n  }\n\n  .codeflask__flatten {\n    padding: 10px;\n    font-size: 16px;\n    line-height: 20px;\n    white-space: pre;\n    position: absolute;\n    top: 0;\n    left: 0;\n    overflow: auto;\n    margin: 0 !important;\n    outline: none;\n    text-align: left;\n  }\n\n  .codeflask--has-line-numbers .codeflask__flatten {\n    width: calc(100% - 40px);\n    left: 40px;\n  }\n\n  .codeflask__line-highlight {\n    position: absolute;\n    top: 10px;\n    left: 0;\n    width: 100%;\n    height: 20px;\n    background: rgba(0,0,0,0.1);\n    z-index: 1;\n  }\n\n  .codeflask__lines {\n    padding: 10px 4px;\n    font-size: 12px;\n    line-height: 20px;\n    font-family: 'Cousine', monospace;\n    position: absolute;\n    left: 0;\n    top: 0;\n    width: 40px;\n    min-height: 100%;\n    text-align: right;\n    color: #999;\n    border-right: 1px solid #f8f8f8;\n    background-color: #fafafa;\n    z-index: 5;\n  }\n\n  .codeflask__lines__line {\n    display: block;\n  }\n\n  .codeflask.codeflask--has-line-numbers {\n    padding-left: 40px;\n  }\n\n  .codeflask.codeflask--has-line-numbers:before {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0;\n    width: 40px;\n    height: 100%;\n    background: #eee;\n    z-index: 1;\n  }\n`;function i(e,t,n){const s=t||"codeflask-style",o=n||document.head;if(!e)return!1;if(document.getElementById(s))return!0;const a=document.createElement("style");return a.innerHTML=e,a.id=s,o.appendChild(a),!0}const l={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function r(e){return String(e).replace(/[&<>"'`=/]/g,(function(e){return l[e]}))}const h={"(":")","[":"]","{":"}","<":">","'":"'",'"':'"'};return class{constructor(e,t,n){if(!e)throw Error("CodeFlask expects 1st parameter to be an Element or a String selector");if(!t)throw Error("CodeFlask expects 2nd parameter to be the Prism peer dependency");if(!n)throw Error("CodeFlask expects 3rd parameter to be an object containing options");if(e.nodeType)this.editorRoot=e;else{const t=document.querySelector(e);t&&(this.editorRoot=t)}this.Prism=t,this.opts=n,this.events={},this.startEditor()}startEditor(){if(!i(a,null,this.opts.styleParent))throw Error("Failed to inject CodeFlask CSS.");this.createWrapper(),this.createTextarea(),this.createPre(),this.createCode(),this.runOptions(),this.listenTextarea(),this.populateDefault(),this.updateCode(this.code)}createWrapper(){this.code=this.editorRoot.innerHTML,this.editorRoot.innerHTML="",this.elWrapper=this.createElement("div",this.editorRoot),this.elWrapper.classList.add("codeflask")}createTextarea(){this.elTextarea=this.createElement("textarea",this.elWrapper),this.elTextarea.classList.add("codeflask__textarea","codeflask__flatten")}createPre(){this.elPre=this.createElement("pre",this.elWrapper),this.elPre.classList.add("codeflask__pre","codeflask__flatten")}createCode(){this.elCode=this.createElement("code",this.elPre),this.elCode.classList.add("codeflask__code",`language-${this.opts.language||"html"}`)}createLineNumbers(){this.elLineNumbers=this.createElement("div",this.elWrapper),this.elLineNumbers.classList.add("codeflask__lines"),this.setLineNumber()}createElement(e,t){const n=document.createElement(e);return t.appendChild(n),n}runOptions(){this.opts.rtl=this.opts.rtl||!1,this.opts.tabSize=this.opts.tabSize||2,this.opts.enableAutocorrect=this.opts.enableAutocorrect||!1,this.opts.lineNumbers=this.opts.lineNumbers||!1,this.opts.defaultTheme=!1!==this.opts.defaultTheme,this.opts.areaId=this.opts.areaId||null,this.opts.ariaLabelledby=this.opts.ariaLabelledby||null,this.opts.readonly=this.opts.readonly||!1,this.opts.customEventListeners=this.opts.customEventListeners||{},this.opts.selfClosingCharacters=this.opts.selfClosingCharacters||["(","[","{","<","'",'"'],"boolean"!=typeof this.opts.handleTabs&&(this.opts.handleTabs=!0),"boolean"!=typeof this.opts.handleNewLineIndentation&&(this.opts.handleNewLineIndentation=!0),!0===this.opts.rtl&&(this.elTextarea.setAttribute("dir","rtl"),this.elPre.setAttribute("dir","rtl")),!1===this.opts.enableAutocorrect&&(this.elTextarea.setAttribute("spellcheck","false"),this.elTextarea.setAttribute("autocapitalize","off"),this.elTextarea.setAttribute("autocomplete","off"),this.elTextarea.setAttribute("autocorrect","off")),this.opts.lineNumbers&&(this.elWrapper.classList.add("codeflask--has-line-numbers"),this.createLineNumbers()),this.opts.defaultTheme&&i("\n.codeflask {\n  background: #fff;\n  color: #4f559c;\n}\n\n.codeflask .token.punctuation {\n  color: #4a4a4a;\n}\n\n.codeflask .token.keyword {\n  color: #8500ff;\n}\n\n.codeflask .token.operator {\n  color: #ff5598;\n}\n\n.codeflask .token.string {\n  color: #41ad8f;\n}\n\n.codeflask .token.comment {\n  color: #9badb7;\n}\n\n.codeflask .token.function {\n  color: #8500ff;\n}\n\n.codeflask .token.boolean {\n  color: #8500ff;\n}\n\n.codeflask .token.number {\n  color: #8500ff;\n}\n\n.codeflask .token.selector {\n  color: #8500ff;\n}\n\n.codeflask .token.property {\n  color: #8500ff;\n}\n\n.codeflask .token.tag {\n  color: #8500ff;\n}\n\n.codeflask .token.attr-value {\n  color: #8500ff;\n}\n","theme-default",this.opts.styleParent),this.opts.areaId&&this.elTextarea.setAttribute("id",this.opts.areaId),this.opts.ariaLabelledby&&this.elTextarea.setAttribute("aria-labelledby",this.opts.ariaLabelledby),this.opts.readonly&&this.enableReadonlyMode()}updateLineNumbersCount(){let e="";for(let t=1;t<=this.lineNumber;t++)e+=`<span class="codeflask__lines__line">${t}</span>`;this.elLineNumbers.innerHTML=e}listenTextarea(){const e=this.opts.customEventListeners;for(const[t,n]of Object.entries(e))this.elTextarea.addEventListener(t,n);this.elTextarea.addEventListener("input",this.events.input=e=>{this.opts.readonly||(this.code=e.target.value,this.elCode.innerHTML=r(e.target.value),this.highlight(),setTimeout((()=>{this.runUpdate(),this.setLineNumber()}),1))}),this.elTextarea.addEventListener("keydown",this.events.keydown=e=>{this.opts.readonly||(this.handleTabs(e),this.handleBackspace(e),this.handleSelfClosingCharacters(e),this.handleNewLineIndentation(e))}),this.elTextarea.addEventListener("scroll",this.events.scroll=e=>{this.elPre.style.transform=`translate3d(-${e.target.scrollLeft}px, -${e.target.scrollTop}px, 0)`,this.elLineNumbers&&(this.elLineNumbers.style.transform=`translate3d(0, -${e.target.scrollTop}px, 0)`,this.elPre.style.width=`calc(100% - 40px + ${e.target.scrollLeft}px)`)})}removeEventListeners(){for(const[e,t]of Object.entries(customEventListeners))this.elTextarea.removeEventListener(e,t);for(const[e,t]of Object.entries(this.events))this.elTextarea.removeEventListener(e,t)}getSelectInfo(){var e=this.elTextarea,t=e.selectionStart,n=e.selectionEnd;return{selStartPos:t,selEndPos:n,beforeSelection:e.value.substr(0,t),selectionVal:e.value.substring(t,n),afterSelection:e.value.substring(n)}}handleTabs(e){if(!this.opts.handleTabs||"Tab"!==e.key)return;e.preventDefault();var t=this.elTextarea,n=t.value,{selStartPos:s,selEndPos:o,beforeSelection:a,selectionVal:i,afterSelection:l}=this.getSelectInfo();const r=" ".repeat(this.opts.tabSize);if(s!==o&&i.length>=r.length){var h=s-a.split("\n").pop().length,c=r.length,d=r.length;if(e.shiftKey)n.substr(h,r.length)===r?(c=-c,h>s?(i=i.substring(0,h)+i.substring(h+r.length),d=0):h===s?(c=0,d=0,i=i.substring(r.length)):(d=-d,a=a.substring(0,h)+a.substring(h+r.length))):(c=0,d=0),i=i.replace(new RegExp("\n"+r.split("").join("\\"),"g"),"\n");else a=a.substr(0,h)+r+a.substring(h,s),i=i.replace(/\n/g,"\n"+r);t.value=a+i+l,t.setSelectionRange(s+c,s+i.length+d)}else{const n=new RegExp(`(\\n?)((?:${r})*)([^\\n]*)$`);if(e.shiftKey){const e=a.replace(n,((e,t,n,s)=>t+n.slice(0,-1*r.length)+s));e!==a&&(t.value=e+l,t.setSelectionRange(s-r.length,s-r.length))}else{const e=a.replace(n,((e,t,n,s)=>t+n+r+s));t.value=e+l,t.setSelectionRange(s+r.length,s+r.length)}}this.updateCode(t.value)}handleBackspace(e){if("Backspace"!==e.key)return;var{selStartPos:t,beforeSelection:n,selectionVal:s,afterSelection:o}=this.getSelectInfo();if(""!==s)return;if(!n.match(/\n(  ){1,}$/))return;e.preventDefault();const a=n.replace(/  $/,""),i=this.elTextarea;i.value=a+o,this.updateCode(i.value),i.setSelectionRange(t-2,t-2)}handleSelfClosingCharacters(e){if(!this.opts.selfClosingCharacters.length)return;const t=this.opts.selfClosingCharacters,n=this.opts.selfClosingCharacters.map((e=>h[e]));(t.includes(e.key)||n.includes(e.key))&&(e.metaKey||e.ctrlKey||this.closeCharacter(e.key))}setLineNumber(){this.lineNumber=this.code.split("\n").length,this.opts.lineNumbers&&this.updateLineNumbersCount()}handleNewLineIndentation(e){if(this.opts.handleNewLineIndentation&&13===e.keyCode){e.preventDefault();var t=this.elTextarea,n=t.value,{selStartPos:s,beforeSelection:o,afterSelection:a}=this.getSelectInfo(),i=n.lastIndexOf("\n",s-1),l=i+n.slice(i+1).search(/[^ ]|$/),r=l>i?l-i:0,h=o+"\n"+" ".repeat(r)+a;t.value=h,t.selectionStart=s+r+1,t.selectionEnd=s+r+1,this.updateCode(t.value)}}closeCharacter(e){const t=this.elTextarea.selectionStart,n=this.elTextarea.selectionEnd;if(this.skipCloseChar(e)){const s=this.code.substr(n,1)===e,o=s?n+1:n,a=!s&&["'",'"'].includes(e)?e:"",i=`${this.code.substring(0,t)}${a}${this.code.substring(o)}`;this.updateCode(i),this.elTextarea.selectionEnd=++this.elTextarea.selectionStart}else{let s=e;switch(e){case"(":s=String.fromCharCode(e.charCodeAt()+1);break;case"<":case"{":case"[":s=String.fromCharCode(e.charCodeAt()+2)}const o=this.code.substring(t,n),a=`${this.code.substring(0,t)}${o}${s}${this.code.substring(n)}`;this.updateCode(a)}this.elTextarea.selectionEnd=t}skipCloseChar(e){const t=this.elTextarea.selectionStart,n=this.elTextarea.selectionEnd,s=Math.abs(n-t)>0;return[")","}","]",">"].includes(e)||["'",'"'].includes(e)&&!s}updateCode(e){this.code=e,this.elTextarea.value=e,this.elCode.innerHTML=r(e),this.highlight(),this.setLineNumber(),setTimeout(this.runUpdate.bind(this),1)}updateLanguage(e){const t=this.opts.language;this.elCode.classList.remove(`language-${t}`),this.elCode.classList.add(`language-${e}`),this.opts.language=e,this.highlight()}addLanguage(e,t){this.Prism.languages[e]=t}populateDefault(){this.updateCode(this.code)}blur(){this.elTextarea.blur()}highlight(){this.Prism.highlightElement(this.elCode,!1)}highlightLines(e){this.elPre.setAttribute("data-line",e),this.highlight()}onUpdate(e){if(e&&"[object Function]"!=={}.toString.call(e))throw Error("CodeFlask expects callback of type Function");this.updateCallBack=e}getCode(){return this.code}runUpdate(){this.updateCallBack&&this.updateCallBack(this.code)}enableReadonlyMode(){this.elTextarea.setAttribute("readonly",!0)}disableReadonlyMode(){this.elTextarea.removeAttribute("readonly")}}}));
